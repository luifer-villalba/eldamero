---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import ShareButtons from '../components/ShareButtons.astro';

interface Props {
    data: CollectionEntry<'planchas'>['data'];
    slug: string;
    prev?: CollectionEntry<'planchas'> | null;
    next?: CollectionEntry<'planchas'> | null;
    headings: { depth: number; slug: string; text: string }[];
}

const { data, slug, prev, next } = Astro.props;
const { title, date, grado, tema, autor, tags = [], orden } = data;

const description = `Plancha ${orden} sobre ${tema} - Grado ${grado}. ${title}`;
const keywords = [tema, grado, 'masonería', 'Lavagnini', autor, ...tags].join(', ');
const publishedTime = date.toISOString();
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const pageUrl = `/planchas/${slug}`;

// Máximo 3 tags
const displayTags = tags.slice(0, 3);
---

<BaseLayout
        title={`${title} | El Damero`}
        description={description}
        type="article"
>
    <Fragment slot="head">
        <meta name="keywords" content={keywords} />
        <meta name="author" content={autor} />
        <meta property="article:published_time" content={publishedTime} />
        <meta property="article:author" content={autor} />
        <meta property="article:section" content={grado} />
        <meta property="article:tag" content={tema} />
    </Fragment>

    <div class="plancha-wrapper">
        <Breadcrumbs grado={grado} title={title} />

        <article class="plancha">
            <!-- HEADER LIMPIO -->
            <header>
                <div class="header-meta">
                    <span class="numero">Plancha Nº {orden.toString().padStart(2, '0')}</span>
                    <span class="grado">{grado}</span>
                </div>

                <h1>{title}</h1>

                <p class="tema">{tema}</p>
            </header>

            <!-- CONTENIDO -->
            <div class="contenido">
                <slot />
            </div>

            <!-- TAGS AL FINAL (máximo 3) -->
            {displayTags.length > 0 && (
                    <footer class="tags-footer">
                        {displayTags.map(tag => (
                                <a href={`/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="tag">
                                    {tag}
                                </a>
                        ))}
                    </footer>
            )}

            <!-- FIRMA -->
            <div class="firma">
                <div class="autor">{autor}</div>
                <div class="rango">M∴ M∴</div>
                <div class="despedida">S∴ F∴ U∴</div>
            </div>

            <!-- NAVEGACIÓN -->
            <nav class="plancha-nav no-print">
                {prev ? (
                        <a href={`/planchas/${prev.slug}`} class="nav-link prev">
                            <span class="arrow">←</span>
                            <span class="nav-title">{prev.data.title}</span>
                        </a>
                ) : <div class="nav-placeholder"></div>}

                <a href="/" class="nav-link home">
                    <span>⌂</span>
                </a>

                {next ? (
                        <a href={`/planchas/${next.slug}`} class="nav-link next">
                            <span class="nav-title">{next.data.title}</span>
                            <span class="arrow">→</span>
                        </a>
                ) : <div class="nav-placeholder"></div>}
            </nav>
        </article>
    </div>

    <!-- JSON-LD Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": title,
        "description": description,
        "author": { "@type": "Person", "name": autor },
        "datePublished": publishedTime,
        "inLanguage": "es-AR",
        "keywords": keywords,
        "articleSection": grado,
        "about": { "@type": "Thing", "name": tema },
        "publisher": {
            "@type": "Organization",
            "name": "El Damero",
            "url": "https://eldamero.com"
        },
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": canonicalURL.toString()
        }
    })} />
</BaseLayout>

<style>
    .plancha-wrapper {
        max-width: 1100px;
        margin: 0 auto;
        padding: var(--spacing-lg);
    }

    .plancha {
        background: var(--damero-dark);
        border: 2px solid var(--damero-gold);
        padding: var(--spacing-xl);
    }

    /* ========== HEADER LIMPIO ========== */
    header {
        text-align: center;
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--damero-gold);
    }

    .header-meta {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
        align-items: center;
        margin-bottom: var(--spacing-md);
        font-size: 0.85rem;
        color: var(--damero-gray);
    }

    .numero {
        letter-spacing: 0.2em;
        font-weight: 600;
    }

    .grado {
        padding: 4px 12px;
        border: 1px solid var(--damero-gold);
        color: var(--damero-gold);
    }

    h1 {
        font-size: 2rem;
        line-height: 1.2;
        margin: var(--spacing-md) 0;
        color: var(--damero-gold);
    }

    .tema {
        color: var(--damero-gray);
        font-style: italic;
        font-size: 1rem;
    }

    /* ========== CONTENIDO ========== */
    .contenido {
        line-height: 1.8;
        font-size: 1.05rem;
        margin-bottom: var(--spacing-xl);
    }

    .contenido :global(p) {
        margin-bottom: var(--spacing-md);
        text-align: justify;
    }

    .contenido :global(h2) {
        color: var(--damero-gold);
        margin-top: var(--spacing-lg);
        margin-bottom: var(--spacing-sm);
        font-size: 1.3rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .contenido :global(h3) {
        color: var(--damero-gray-light);
        margin-top: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        font-size: 1.1rem;
    }

    .contenido :global(ul),
    .contenido :global(ol) {
        margin-left: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
    }

    .contenido :global(li) {
        margin-bottom: var(--spacing-xs);
    }

    .contenido :global(em) {
        color: var(--damero-gold);
        font-style: italic;
    }

    .contenido :global(strong) {
        color: var(--damero-gold-light);
    }

    /* ========== TAGS AL FINAL ========== */
    .tags-footer {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: center;
        margin: var(--spacing-xl) 0;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--damero-gold);
    }

    .tag {
        font-size: 0.8rem;
        padding: 4px 12px;
        border: 1px solid var(--damero-gold);
        color: var(--damero-gold);
        text-decoration: none;
        transition: var(--transition-smooth);
    }

    .tag:hover {
        background: var(--damero-gold);
        color: var(--damero-black);
    }

    /* ========== FIRMA ========== */
    .firma {
        text-align: center;
        margin: var(--spacing-xl) 0;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--damero-gold);
        font-size: 0.9rem;
        line-height: 1.6;
    }

    .autor {
        color: var(--damero-gold);
        font-weight: 600;
    }

    .rango {
        color: var(--damero-gold);
        font-size: 0.85rem;
    }

    .despedida {
        color: var(--damero-gray);
        font-size: 0.85rem;
    }

    /* ========== NAVEGACIÓN ========== */
    .plancha-nav {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-xl);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--damero-gold);
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm);
        border: 1px solid var(--damero-gold);
        color: var(--damero-gold);
        text-decoration: none;
        transition: var(--transition-smooth);
        font-size: 0.9rem;
    }

    .nav-link:hover {
        background: var(--damero-gold);
        color: var(--damero-black);
    }

    .nav-link.prev {
        justify-content: flex-start;
    }

    .nav-link.next {
        justify-content: flex-end;
    }

    .nav-link.home {
        justify-content: center;
        font-size: 1.2rem;
    }

    .arrow {
        font-size: 1.2rem;
        line-height: 1;
    }

    .nav-title {
        font-size: 0.85rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .nav-placeholder {
        visibility: hidden;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .plancha {
            padding: var(--spacing-md);
        }

        h1 {
            font-size: 1.6rem;
        }

        .header-meta {
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .plancha-nav {
            grid-template-columns: 1fr;
            gap: var(--spacing-xs);
        }

        .nav-link.home {
            order: -1;
        }

        .nav-title {
            max-width: none;
        }
    }

    /* ========== IMPRESIÓN ========== */
    @media print {
        .no-print,
        .plancha-nav,
        .tags-footer {
            display: none !important;
        }

        .plancha {
            border: none;
            padding: 0;
        }

        .contenido :global(p) {
            text-align: left;
        }
    }
</style>