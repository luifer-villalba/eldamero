---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import SearchBar from '../components/SearchBar.astro';
import FilterBar from '../components/FilterBar.astro';
import PlanchaCard from '../components/PlanchaCard.astro';
import Footer from '../components/Footer.astro';

// 1. Desestructuración para obtener 'data' directamente en el map
const planchas = await getCollection('planchas');
const sorted = planchas.sort((a, b) => a.data.orden - b.data.orden);
const grados = [...new Set(planchas.map(p => p.data.grado))].sort();

const websiteSchema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "El Damero",
    "description": "Del Aprendiz al Maestro: estudio operativo de los tres grados simbólicos de la masonería",
    "url": "https://eldamero.com",
    "inLanguage": "es-AR",
    "potentialAction": {
        "@type": "SearchAction",
        "target": {
            "@type": "EntryPoint",
            "urlTemplate": "https://eldamero.com/?q={search_term_string}"
        },
        "query-input": "required name=search_term_string"
    }
};
---

<BaseLayout title="El Damero | El Damero | Planchas Masónicas">
    <Header />

    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    {sorted.length > 0 && (
            <>
                {/* ═══════════════════════════════════════════ */}
                {/* CORRECCIÓN: SearchBar y FilterBar envueltos para fondo de 100% */}
                {/* ═══════════════════════════════════════════ */}

                <div class="search-wrapper">
                    <div class="container">
                        <SearchBar />
                    </div>
                </div>

                <div class="filter-wrapper">
                    <div class="container">
                        <FilterBar grados={grados} />
                    </div>
                </div>
            </>
    )}

    <div class="container planchas-grid-container">
        {sorted.length > 0 ? (
                <div class="planchas-grid">
                    {sorted.map(({ data, slug }) => ( // <- MEJORA: Desestructuración
                    <PlanchaCard
                                    title={data.title}
                                    slug={slug}
                                    grado={data.grado}
                                    date={data.date}
                                    tema={data.tema}
                                    autor={data.autor}
                                    orden={data.orden}
                            />
                    ))}
                </div>
        ) : (
                <div class="empty">
                    <p>Sin planchas aún. Comenzá a agregar tus trazados.</p>
                </div>
        )}
    </div>

    <Footer />
</BaseLayout>

<style>
    /* ═══════════════════════════════════════════
       Estilos de los Wrappers (Fondo 100%)
       ═══════════════════════════════════════════ */
    .search-wrapper,
    .filter-wrapper {
        /* CAMBIO CLAVE: Fondo transparente */
        background-color: transparent;
        /* Ajustamos la sombra para que se note sobre el fondo unificado */
        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.4);
    }

    .filter-wrapper {
        margin-bottom: var(--spacing-lg);
    }

    /* ═══════════════════════════════════════════
       Estilos del Grid
       ═══════════════════════════════════════════ */
    .planchas-grid-container {
        padding-top: var(--spacing-lg);
    }

    .planchas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
    }

    /* El diseño de la caja "empty" ahora usa el color más oscuro (damero-darker) */
    .empty {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--damero-gray);
        border: 1px dashed var(--damero-gray);
        background: var(--damero-darker); /* CORREGIDO: Usamos el mismo color que las bandas */
        border-radius: 5px;
    }
</style>